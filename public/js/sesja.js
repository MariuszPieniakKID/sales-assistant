// sesja.js - ZarzƒÖdzanie sesjami sprzeda≈ºowymi

let clients = [];
let products = [];
let currentSession = null;
let recordingTimer = null;
let recordingStartTime = null;

// Elementy DOM
const sessionClientSelect = document.getElementById('sessionClient');
const sessionProductSelect = document.getElementById('sessionProduct');
const sessionNotesTextarea = document.getElementById('sessionNotes');
const startSessionBtn = document.getElementById('startSessionBtn');
const sessionStatus = document.getElementById('sessionStatus');
const recentSessionsList = document.getElementById('recentSessionsList');

// Funkcja pomocnicza do fetch z automatycznym sprawdzaniem sesji
async function fetchWithAuth(url, options = {}) {
    try {
        const response = await fetch(url, options);
        
        // Sprawd≈∫ czy odpowied≈∫ wskazuje na wygas≈ÇƒÖ sesjƒô
        if (response.status === 401) {
            console.log('‚ùå API zwr√≥ci≈Ço 401 - sesja wygas≈Ça w sesja.js');
            window.location.href = '/login';
            return null;
        }
        
        // Dodatkowe sprawdzenie - czy nie dostali≈õmy HTML przekierowania
        if (response.ok && response.url.includes('/login')) {
            console.log('‚ùå Otrzymano przekierowanie do /login przez URL w sesja.js');
            window.location.href = '/login';
            return null;
        }
        
        return response;
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd fetchWithAuth w sesja.js:', error);
        throw error;
    }
}

// Inicjalizacja
document.addEventListener('DOMContentLoaded', function() {
    console.log('üé¨ Inicjalizacja sekcji sesja...');
    loadClients();
    loadProducts();
    loadRecentSessions();
    setupEventListeners();
});

// Konfiguracja event listener√≥w
function setupEventListeners() {
    // Wyb√≥r klienta i produktu
    sessionClientSelect.addEventListener('change', validateSessionForm);
    sessionProductSelect.addEventListener('change', validateSessionForm);
    
    // Rozpoczƒôcie sesji
    startSessionBtn.addEventListener('click', startSession);
    
    // Kontrola sesji
    document.getElementById('pauseSessionBtn')?.addEventListener('click', pauseSession);
    document.getElementById('stopSessionBtn')?.addEventListener('click', stopSession);
}

// ≈Åadowanie klient√≥w
async function loadClients() {
    try {
        console.log('üì• ≈Åadowanie klient√≥w...');
        const response = await fetchWithAuth('/api/clients');
        
        if (!response) {
            // fetchWithAuth ju≈º obs≈Çu≈ºy≈Ç przekierowanie
            return;
        }
        
        if (!response.ok) {
            throw new Error('B≈ÇƒÖd pobierania klient√≥w');
        }
        
        clients = await response.json();
        console.log('‚úÖ Za≈Çadowano klient√≥w:', clients.length);
        populateClientSelect();
        
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd ≈Çadowania klient√≥w:', error);
        showToast('B≈ÇƒÖd ≈Çadowania klient√≥w', 'error');
    }
}

// ≈Åadowanie produkt√≥w
async function loadProducts() {
    try {
        console.log('üì• ≈Åadowanie produkt√≥w...');
        const response = await fetchWithAuth('/api/products');
        
        if (!response) {
            // fetchWithAuth ju≈º obs≈Çu≈ºy≈Ç przekierowanie
            return;
        }
        
        if (!response.ok) {
            throw new Error('B≈ÇƒÖd pobierania produkt√≥w');
        }
        
        products = await response.json();
        console.log('‚úÖ Za≈Çadowano produkt√≥w:', products.length);
        populateProductSelect();
        
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd ≈Çadowania produkt√≥w:', error);
        showToast('B≈ÇƒÖd ≈Çadowania produkt√≥w', 'error');
    }
}

// Wype≈Çnienie listy klient√≥w
function populateClientSelect() {
    sessionClientSelect.innerHTML = '<option value="">-- Wybierz klienta --</option>';
    
    clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        sessionClientSelect.appendChild(option);
    });
}

// Wype≈Çnienie listy produkt√≥w
function populateProductSelect() {
    sessionProductSelect.innerHTML = '<option value="">-- Wybierz produkt --</option>';
    
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = product.name;
        sessionProductSelect.appendChild(option);
    });
}

// Walidacja formularza sesji
function validateSessionForm() {
    const clientSelected = sessionClientSelect.value !== '';
    const productSelected = sessionProductSelect.value !== '';
    
    startSessionBtn.disabled = !(clientSelected && productSelected);
}

// Rozpoczƒôcie sesji
async function startSession() {
    const clientId = sessionClientSelect.value;
    const productId = sessionProductSelect.value;
    const notes = sessionNotesTextarea.value;
    
    if (!clientId || !productId) {
        showToast('Proszƒô wybierz klienta i produkt', 'error');
        return;
    }
    
    try {
        // Sprawd≈∫ czy przeglƒÖdarka obs≈Çuguje nagrywanie
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showToast('Twoja przeglƒÖdarka nie obs≈Çuguje nagrywania audio', 'error');
            return;
        }
        
        // Popro≈õ o dostƒôp do mikrofonu
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Utw√≥rz sesjƒô
        currentSession = {
            clientId: clientId,
            productId: productId,
            notes: notes,
            stream: stream,
            startTime: new Date()
        };
        
        // Poka≈º interfejs nagrywania
        showRecordingInterface();
        
        // Rozpocznij timer
        startRecordingTimer();
        
        showToast('Sesja rozpoczƒôta - nagrywanie w toku', 'success');
        
    } catch (error) {
        console.error('B≈ÇƒÖd rozpoczynania sesji:', error);
        if (error.name === 'NotAllowedError') {
            showToast('Dostƒôp do mikrofonu zosta≈Ç odrzucony', 'error');
        } else {
            showToast('B≈ÇƒÖd rozpoczynania sesji: ' + error.message, 'error');
        }
    }
}

// Pokazanie interfejsu nagrywania
function showRecordingInterface() {
    // Ukryj formularz konfiguracji
    document.querySelector('.setup-card').style.display = 'none';
    
    // Poka≈º status sesji
    sessionStatus.style.display = 'block';
    
    // Wype≈Çnij informacje o sesji
    const selectedClient = clients.find(c => c.id == currentSession.clientId);
    const selectedProduct = products.find(p => p.id == currentSession.productId);
    
    document.getElementById('currentClientName').textContent = selectedClient ? selectedClient.name : '-';
    document.getElementById('currentProductName').textContent = selectedProduct ? selectedProduct.name : '-';
}

// Rozpoczƒôcie timera nagrywania
function startRecordingTimer() {
    recordingStartTime = Date.now();
    recordingTimer = setInterval(updateRecordingTime, 1000);
}

// Aktualizacja czasu nagrywania
function updateRecordingTime() {
    if (!recordingStartTime) return;
    
    const elapsed = Date.now() - recordingStartTime;
    const hours = Math.floor(elapsed / 3600000);
    const minutes = Math.floor((elapsed % 3600000) / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    
    const timeString = 
        String(hours).padStart(2, '0') + ':' +
        String(minutes).padStart(2, '0') + ':' +
        String(seconds).padStart(2, '0');
    
    document.getElementById('recordingTime').textContent = timeString;
}

// Wstrzymanie sesji
function pauseSession() {
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
    
    const pauseBtn = document.getElementById('pauseSessionBtn');
    pauseBtn.innerHTML = '<i class="fas fa-play"></i> Wzn√≥w';
    pauseBtn.onclick = resumeSession;
    
    showToast('Sesja wstrzymana', 'info');
}

// Wznowienie sesji
function resumeSession() {
    startRecordingTimer();
    
    const pauseBtn = document.getElementById('pauseSessionBtn');
    pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Wstrzymaj';
    pauseBtn.onclick = pauseSession;
    
    showToast('Sesja wznowiona', 'info');
}

// Zako≈Ñczenie sesji
async function stopSession() {
    if (!currentSession) return;
    
    try {
        // Zatrzymaj timer
        if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
        }
        
        // Zatrzymaj strumie≈Ñ audio
        if (currentSession.stream) {
            currentSession.stream.getTracks().forEach(track => track.stop());
        }
        
        // Zapisz sesjƒô (symulacja - w rzeczywisto≈õci wys≈Ça≈Çby≈õ nagranie do serwera)
        const sessionData = {
            clientId: currentSession.clientId,
            productId: currentSession.productId,
            notes: currentSession.notes,
            duration: Date.now() - recordingStartTime,
            endTime: new Date()
        };
        
        console.log('Sesja zako≈Ñczona:', sessionData);
        
        // Reset interfejsu
        resetSessionInterface();
        
        // Od≈õwie≈º ostatnie sesje
        loadRecentSessions();
        
        showToast('Sesja zako≈Ñczona i zapisana', 'success');
        
    } catch (error) {
        console.error('B≈ÇƒÖd ko≈Ñczenia sesji:', error);
        showToast('B≈ÇƒÖd ko≈Ñczenia sesji', 'error');
    }
}

// Reset interfejsu sesji
function resetSessionInterface() {
    // Poka≈º formularz konfiguracji
    document.querySelector('.setup-card').style.display = 'block';
    
    // Ukryj status sesji
    sessionStatus.style.display = 'none';
    
    // Wyczy≈õƒá formularz
    sessionClientSelect.value = '';
    sessionProductSelect.value = '';
    sessionNotesTextarea.value = '';
    
    // Reset zmiennych
    currentSession = null;
    recordingStartTime = null;
    
    // Waliduj formularz
    validateSessionForm();
}

// ≈Åadowanie ostatnich sesji
async function loadRecentSessions() {
    try {
        const response = await fetch('/api/sales');
        
        if (!response.ok) {
            throw new Error('B≈ÇƒÖd pobierania sesji');
        }
        
        const sessions = await response.json();
        displayRecentSessions(sessions.slice(0, 5)); // Ostatnie 5 sesji
        
    } catch (error) {
        console.error('B≈ÇƒÖd ≈Çadowania sesji:', error);
    }
}

// Wy≈õwietlenie ostatnich sesji
function displayRecentSessions(sessions) {
    if (sessions.length === 0) {
        recentSessionsList.innerHTML = `
            <div class="no-sessions">
                <i class="fas fa-microphone-slash"></i>
                <p>Brak ostatnich sesji</p>
            </div>
        `;
        return;
    }
    
    recentSessionsList.innerHTML = sessions.map(session => `
        <div class="session-item">
            <div class="session-details">
                <div class="session-title">${session.client_name} - ${session.product_name}</div>
                <div class="session-meta">${new Date(session.meeting_datetime).toLocaleString('pl-PL')}</div>
            </div>
            <div class="session-duration">
                <i class="fas fa-clock"></i>
                ${formatDuration(session.created_at)}
            </div>
        </div>
    `).join('');
}

// Formatowanie czasu trwania
function formatDuration(timestamp) {
    // Placeholder - w rzeczywisto≈õci oblicza≈Çby≈õ rzeczywisty czas trwania
    return '15:30';
}

// Funkcja toast (fallback je≈õli nie istnieje globalnie)
function showToast(message, type = 'info') {
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
        return;
    }
    
    // Fallback
    if (type === 'error') {
        alert('B≈ÇƒÖd: ' + message);
    } else {
        alert(message);
    }
} 