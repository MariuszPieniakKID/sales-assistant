<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostyka Systemu - Sales Assistant</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .test-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }
        
        .test-content {
            padding: 20px;
        }
        
        .test-result {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-result.success {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        
        .test-result.error {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-result.loading {
            border-color: #007bff;
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: transform 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-loading { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { background: #6c757d; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .actions {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostyka Systemu - Skrypty Sprzeda≈ºowe</h1>
        
        <div class="actions">
            <button class="btn" onclick="runAllTests()">‚ñ∂Ô∏è Uruchom wszystkie testy</button>
            <button class="btn" onclick="runSingleTest('database-structure')">üóÑÔ∏è Test struktury bazy</button>
            <button class="btn" onclick="runSingleTest('simple-product')">üì¶ Test prostego produktu</button>
            <button class="btn" onclick="runSingleTest('product-with-script')">üìÑ Test produktu ze skryptem</button>
            <button class="btn" onclick="showLiveLogs()">üñ•Ô∏è Logi serwera</button>
        </div>

        <!-- Test 1: Struktura bazy danych -->
        <div class="test-section">
            <div class="test-header">
                <span class="status-indicator status-pending" id="status-database"></span>
                üóÑÔ∏è Test 1: Struktura bazy danych
            </div>
            <div class="test-content">
                <p>Sprawdza czy kolumny skrypt√≥w sprzeda≈ºowych zosta≈Çy prawid≈Çowo dodane do tabeli products.</p>
                <div class="test-result" id="result-database">Naci≈õnij przycisk powy≈ºej aby uruchomiƒá test...</div>
            </div>
        </div>

        <!-- Test 2: Prosty produkt -->
        <div class="test-section">
            <div class="test-header">
                <span class="status-indicator status-pending" id="status-simple"></span>
                üì¶ Test 2: Dodawanie prostego produktu
            </div>
            <div class="test-content">
                <p>Testuje dodawanie produktu bez skryptu sprzeda≈ºowego (stara funkcjonalno≈õƒá).</p>
                <div class="test-result" id="result-simple">Naci≈õnij przycisk powy≈ºej aby uruchomiƒá test...</div>
            </div>
        </div>

        <!-- Test 3: Produkt ze skryptem -->
        <div class="test-section">
            <div class="test-header">
                <span class="status-indicator status-pending" id="status-script"></span>
                üìÑ Test 3: Dodawanie produktu ze skryptem sprzeda≈ºowym
            </div>
            <div class="test-content">
                <p>Testuje dodawanie produktu z tekstem skryptu sprzeda≈ºowego (nowa funkcjonalno≈õƒá).</p>
                <div class="test-result" id="result-script">Naci≈õnij przycisk powy≈ºej aby uruchomiƒá test...</div>
            </div>
        </div>

        <!-- Sekcja log√≥w serwera -->
        <div class="test-section" id="logs-section" style="display: none;">
            <div class="test-header">
                <span class="status-indicator status-pending" id="status-logs"></span>
                üìÑ Logi serwera - ostatnie b≈Çƒôdy produkt√≥w
                <button class="btn" style="float: right; padding: 4px 8px; font-size: 12px;" onclick="refreshLogs()">üîÑ Od≈õwie≈º</button>
            </div>
            <div class="test-content">
                <p>Ostatnie logi zwiƒÖzane z produktami, PDF i b≈Çƒôdami (automatyczne od≈õwie≈ºanie co 5 sekund).</p>
                <div class="test-result" id="result-logs" style="max-height: 500px; font-size: 11px;">Kliknij "Poka≈º logi serwera" aby uruchomiƒá...</div>
            </div>
        </div>
    </div>

    <script>
        let testResults = {};

        async function runAllTests() {
            console.log('üöÄ Uruchamianie wszystkich test√≥w diagnostycznych...');
            
            // Reset wszystkich status√≥w
            resetAllStatuses();
            
            // Uruchom testy sekwencyjnie
            await runSingleTest('database-structure');
            await runSingleTest('simple-product');
            await runSingleTest('product-with-script');
            
            console.log('‚úÖ Wszystkie testy uko≈Ñczone:', testResults);
        }

        async function runSingleTest(testType) {
            let endpoint, statusId, resultId, testName;
            
            switch(testType) {
                case 'database-structure':
                    endpoint = '/api/debug/database-structure';
                    statusId = 'status-database';
                    resultId = 'result-database';
                    testName = 'Struktura bazy danych';
                    break;
                case 'simple-product':
                    endpoint = '/api/debug/test-product';
                    statusId = 'status-simple';
                    resultId = 'result-simple';
                    testName = 'Prosty produkt';
                    break;
                case 'product-with-script':
                    endpoint = '/api/debug/test-product-with-script';
                    statusId = 'status-script';
                    resultId = 'result-script';
                    testName = 'Produkt ze skryptem';
                    break;
                default:
                    console.error('Nieznany typ testu:', testType);
                    return;
            }
            
            // Ustaw status loading
            setStatus(statusId, 'loading');
            setResult(resultId, `‚è≥ Wykonywanie testu "${testName}"...`, 'loading');
            
            try {
                const method = testType === 'database-structure' ? 'GET' : 'POST';
                
                console.log(`üîç Uruchamianie testu: ${testName} (${method} ${endpoint})`);
                
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    setStatus(statusId, 'success');
                    setResult(resultId, formatSuccessResult(testType, data), 'success');
                    testResults[testType] = { success: true, data };
                    console.log(`‚úÖ Test "${testName}" zako≈Ñczony sukcesem:`, data);
                } else {
                    setStatus(statusId, 'error');
                    setResult(resultId, formatErrorResult(testType, data), 'error');
                    testResults[testType] = { success: false, data };
                    console.error(`‚ùå Test "${testName}" zako≈Ñczony b≈Çƒôdem:`, data);
                }
                
            } catch (error) {
                setStatus(statusId, 'error');
                setResult(resultId, `‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem:\n\n${error.message}\n\nStack trace:\n${error.stack}`, 'error');
                testResults[testType] = { success: false, error: error.message };
                console.error(`üí• Test "${testName}" - b≈ÇƒÖd po≈ÇƒÖczenia:`, error);
            }
        }

        function formatSuccessResult(testType, data) {
            switch(testType) {
                case 'database-structure':
                    let result = `‚úÖ STRUKTURA BAZY DANYCH - SUKCES\n\n`;
                    result += `üë§ User ID: ${data.user_id}\n`;
                    result += `üìä ≈ÅƒÖcznie produkt√≥w: ${data.test_query_result.total}\n\n`;
                    result += `üèóÔ∏è STRUKTURA TABELI PRODUCTS:\n`;
                    result += `${'='.repeat(80)}\n`;
                    
                    data.table_structure.forEach(col => {
                        result += `üìã ${col.column_name.padEnd(25)} | ${col.data_type.padEnd(20)} | nullable: ${col.is_nullable}\n`;
                    });
                    
                    // Sprawd≈∫ czy kolumny skryptu istniejƒÖ
                    const scriptColumns = data.table_structure.filter(col => 
                        ['sales_script_text', 'sales_script_filename', 'sales_script_path'].includes(col.column_name)
                    );
                    
                    result += `\nüéØ KOLUMNY SKRYPT√ìW SPRZEDA≈ªOWYCH:\n`;
                    result += `${'='.repeat(50)}\n`;
                    
                    if (scriptColumns.length === 3) {
                        result += `‚úÖ sales_script_text: ${scriptColumns.find(c => c.column_name === 'sales_script_text')?.data_type || 'BRAK'}\n`;
                        result += `‚úÖ sales_script_filename: ${scriptColumns.find(c => c.column_name === 'sales_script_filename')?.data_type || 'BRAK'}\n`;
                        result += `‚úÖ sales_script_path: ${scriptColumns.find(c => c.column_name === 'sales_script_path')?.data_type || 'BRAK'}\n`;
                        result += `\nüéâ Wszystkie kolumny skrypt√≥w sprzeda≈ºowych istniejƒÖ!`;
                    } else {
                        result += `‚ùå Brakuje ${3 - scriptColumns.length} kolumn skrypt√≥w sprzeda≈ºowych!\n`;
                        ['sales_script_text', 'sales_script_filename', 'sales_script_path'].forEach(colName => {
                            const exists = scriptColumns.find(c => c.column_name === colName);
                            result += `${exists ? '‚úÖ' : '‚ùå'} ${colName}: ${exists ? exists.data_type : 'BRAK'}\n`;
                        });
                    }
                    
                    return result;
                    
                case 'simple-product':
                    return `‚úÖ PROSTY PRODUKT - SUKCES\n\n${data.message}\n\nüì¶ UTWORZONY PRODUKT:\n${'='.repeat(50)}\n${JSON.stringify(data.product, null, 2)}`;
                    
                case 'product-with-script':
                    return `‚úÖ PRODUKT ZE SKRYPTEM - SUKCES\n\n${data.message}\n\nüìÑ UTWORZONY PRODUKT:\n${'='.repeat(50)}\n${JSON.stringify(data.product, null, 2)}`;
                    
                default:
                    return `‚úÖ SUKCES\n\n${JSON.stringify(data, null, 2)}`;
            }
        }

        function formatErrorResult(testType, data) {
            let result = `‚ùå B≈ÅƒÑD - ${testType.toUpperCase()}\n\n`;
            
            if (data.error) {
                result += `üí• B≈ÇƒÖd: ${data.error}\n`;
            }
            
            if (data.code) {
                result += `üî¢ Kod b≈Çƒôdu: ${data.code}\n`;
            }
            
            if (data.detail) {
                result += `üìù Szczeg√≥≈Çy: ${data.detail}\n`;
            }
            
            if (data.hint) {
                result += `üí° Wskaz√≥wka: ${data.hint}\n`;
            }
            
            result += `\nüìã PE≈ÅNE DANE B≈ÅƒòDU:\n${'='.repeat(50)}\n${JSON.stringify(data, null, 2)}`;
            
            return result;
        }

        function setStatus(statusId, status) {
            const element = document.getElementById(statusId);
            if (element) {
                element.className = `status-indicator status-${status}`;
            }
        }

        function setResult(resultId, text, type) {
            const element = document.getElementById(resultId);
            if (element) {
                element.textContent = text;
                element.className = `test-result ${type}`;
            }
        }

        function resetAllStatuses() {
            ['database', 'simple', 'script'].forEach(test => {
                setStatus(`status-${test}`, 'pending');
                setResult(`result-${test}`, 'Oczekuje na uruchomienie...', '');
            });
            testResults = {};
        }

        // Sprawd≈∫ czy u≈ºytkownik jest zalogowany
        async function checkAuthentication() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                
                if (!data.authenticated) {
                    // Przekieruj do logowania
                    window.location.href = '/login.html?redirect=/debug.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('B≈ÇƒÖd sprawdzania uwierzytelnienia:', error);
                // W przypadku b≈Çƒôdu, spr√≥buj uruchomiƒá testy - mo≈ºe byƒá zalogowany
                return true;
            }
        }

        // Zmienne dla log√≥w
        let logsInterval = null;

        // Funkcja do pokazywania/ukrywania log√≥w
        function showLiveLogs() {
            const logsSection = document.getElementById('logs-section');
            const isVisible = logsSection.style.display !== 'none';
            
            if (isVisible) {
                // Ukryj logi
                logsSection.style.display = 'none';
                if (logsInterval) {
                    clearInterval(logsInterval);
                    logsInterval = null;
                }
                setStatus('status-logs', 'pending');
                setResult('result-logs', 'Logi ukryte.', '');
            } else {
                // Poka≈º logi
                logsSection.style.display = 'block';
                refreshLogs();
                
                // Automatyczne od≈õwie≈ºanie co 5 sekund
                logsInterval = setInterval(refreshLogs, 5000);
            }
        }

        // Funkcja do od≈õwie≈ºania log√≥w
        async function refreshLogs() {
            setStatus('status-logs', 'loading');
            setResult('result-logs', '‚è≥ Pobieranie log√≥w serwera...', 'loading');
            
            try {
                const response = await fetch('/debug/product-logs');
                const data = await response.json();
                
                if (data.logs) {
                    const formattedLogs = `üìä LOGI SERWERA - OSTATNIE WPISY ZWIƒÑZANE Z PRODUKTAMI
${'='.repeat(80)}
üìÖ Czas: ${new Date(data.timestamp).toLocaleString()}
üìÑ Znalezionych linii: ${data.totalFilteredLines}

${data.logs}

${'='.repeat(80)}
‚ÑπÔ∏è  Logi od≈õwie≈ºajƒÖ siƒô automatycznie co 5 sekund.
‚ÑπÔ∏è  Filtrowane sƒÖ linie zawierajƒÖce: products, pdf, script, error, b≈ÇƒÖd, post, formdata`;
                    
                    setResult('result-logs', formattedLogs, 'success');
                    setStatus('status-logs', 'success');
                } else {
                    setResult('result-logs', '‚ö†Ô∏è Brak log√≥w lub b≈ÇƒÖd dostƒôpu: ' + (data.error || 'Nieznany b≈ÇƒÖd'), 'error');
                    setStatus('status-logs', 'error');
                }
                
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania log√≥w:', error);
                setResult('result-logs', `‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem log√≥w:\n\n${error.message}`, 'error');
                setStatus('status-logs', 'error');
            }
        }

        // Auto-uruchom wszystkie testy po za≈Çadowaniu strony
        window.addEventListener('load', async () => {
            console.log('üöÄ Strona diagnostyczna za≈Çadowana');
            
            // Sprawd≈∫ uwierzytelnienie
            const isAuthenticated = await checkAuthentication();
            
            if (isAuthenticated) {
                setTimeout(() => {
                    runAllTests();
                }, 1000);
            }
        });
    </script>
</body>
</html> 